services:
  # ===== MySQL Database =====
  db:
    image: mysql:8.0
    container_name: chatbot-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-chatbot_root_2026}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-chatbot_db}
      MYSQL_USER: ${MYSQL_USER:-chatbot_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-chatbot_pass_2026}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===== Next.js App =====
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: chatbot-app
    restart: always
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: mysql://${MYSQL_USER:-chatbot_user}:${MYSQL_PASSWORD:-chatbot_pass_2026}@db:3306/${MYSQL_DATABASE:-chatbot_db}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      YAADPAY_MASOF: ${YAADPAY_MASOF:-0010131918}
      YAADPAY_PASSP: ${YAADPAY_PASSP:-yaad}
      YAADPAY_API_KEY: ${YAADPAY_API_KEY}
      YAADPAY_TEST_MODE: ${YAADPAY_TEST_MODE:-true}
    volumes:
      - uploads_data:/app/public/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - default
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=n8n_default"
      - "traefik.http.routers.chatbot.rule=Host(`chatbot.leos.co.il`)"
      - "traefik.http.routers.chatbot.entrypoints=websecure"
      - "traefik.http.routers.chatbot.tls=true"
      - "traefik.http.routers.chatbot.tls.certresolver=mytlschallenge"
      - "traefik.http.services.chatbot.loadbalancer.server.port=3000"

volumes:
  mysql_data:
  uploads_data:

networks:
  traefik_network:
    external: true
    name: n8n_default
