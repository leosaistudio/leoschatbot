// Prisma schema for AI Chatbot SaaS Platform
// Database: MySQL (production)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== Users & Authentication ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  companyName   String?   @map("company_name")
  phone         String?
  role          String    @default("user") // 'user', 'admin'
  status        String    @default("active") // 'active', 'frozen', 'blocked'
  plan          String    @default("free") // 'free', 'pro', 'enterprise'
  monthlyPayment Float    @default(0) @map("monthly_payment") // Monthly subscription amount
  frozenAt      DateTime? @map("frozen_at") // When account was frozen
  notifyEmail   Boolean   @default(true) @map("notify_email")
  whatsappNumber String?  @map("whatsapp_number")
  webhookUrl    String?   @map("webhook_url")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  bots          Bot[]
  creditBalance CreditBalance?
  creditHistory CreditHistory[]
  
  @@map("users")
}

model CreditBalance {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("credit_balances")
}

model CreditHistory {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Int      // positive = added, negative = used
  type        String   // 'purchase', 'usage', 'bonus'
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("credit_history")
}

// ==================== Bots ====================

model Bot {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  name            String
  description     String?  @db.Text
  status          String   @default("draft") // 'draft', 'training', 'active', 'paused'
  
  // AI Settings
  systemPrompt    String?  @map("system_prompt") @db.Text
  welcomeMessage  String?  @map("welcome_message") @db.Text
  temperature     Float    @default(0.7)
  
  // Appearance Settings
  primaryColor    String   @default("#4F46E5") @map("primary_color")
  position        String   @default("bottom-right") // 'bottom-right', 'bottom-left'
  avatarUrl       String?  @map("avatar_url")
  chatIconUrl     String?  @map("chat_icon_url")
  
  // Lead Form Settings
  leadFormEnabled Boolean  @default(true) @map("lead_form_enabled")
  leadFormFields  Json?    @map("lead_form_fields") // Array of field configs
  
  // Suggested Questions
  suggestedQuestions Json? @map("suggested_questions") // Array of strings
  
  // Business Hours Settings
  businessHoursEnabled Boolean @default(false) @map("business_hours_enabled") // Enable schedule
  businessHoursStart   String  @default("09:00") @map("business_hours_start") // Start time HH:MM
  businessHoursEnd     String  @default("18:00") @map("business_hours_end")   // End time HH:MM
  workingDays          Json?   @map("working_days") // Array of days [0-6] where 0=Sunday
  shabbatModeEnabled   Boolean @default(false) @map("shabbat_mode_enabled") // Pause during Shabbat
  offlineMessage       String? @map("offline_message") @db.Text
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingSources TrainingSource[]
  embeddings      Embedding[]
  conversations   Conversation[]
  leads           Lead[]
  sitemapCrawls   SitemapCrawl[]
  productImages   ProductImage[]
  
  @@map("bots")
}

// ==================== Training & Embeddings ====================

model TrainingSource {
  id        String   @id @default(cuid())
  botId     String   @map("bot_id")
  type      String   // 'url', 'text', 'file'
  content   String   @db.LongText // URL or text content
  status    String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  error     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  embeddings Embedding[]
  
  @@map("training_sources")
}

model Embedding {
  id        String   @id @default(cuid())
  botId     String   @map("bot_id")
  sourceId  String   @map("source_id")
  content   String   @db.LongText // Original text chunk
  embedding Json     // Vector stored as JSON array
  createdAt DateTime @default(now()) @map("created_at")
  
  bot       Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  source    TrainingSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  @@index([botId])
  @@map("embeddings")
}

// ==================== Conversations & Messages ====================

model Conversation {
  id          String   @id @default(cuid())
  botId       String   @map("bot_id")
  visitorId   String   @map("visitor_id") // Anonymous visitor ID
  status      String   @default("active") // 'active', 'closed', 'human_takeover'
  visitorName String?  @map("visitor_name")
  visitorEmail String? @map("visitor_email")
  pageUrl     String?  @map("page_url")
  summary     String?  @db.Text // AI generated summary
  sentiment   String?  // positive, negative, neutral
  tokensUsed  Int      @default(0) @map("tokens_used") // Total OpenAI tokens used (for admin)
  creditsUsed Int      @default(0) @map("credits_used") // Number of queries/responses (for users)
  startedAt   DateTime @default(now()) @map("started_at")
  endedAt     DateTime? @map("ended_at")
  
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  messages    Message[]
  
  @@index([botId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  role           String   // 'user', 'assistant', 'system', 'human'
  content        String   @db.LongText
  createdAt      DateTime @default(now()) @map("created_at")
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@map("messages")
}

// ==================== Leads ====================

model Lead {
  id          String   @id @default(cuid())
  botId       String   @map("bot_id")
  name        String?
  email       String?
  phone       String?
  customData  Json?    @map("custom_data") // Additional fields from form
  pageUrl     String?  @map("page_url")
  createdAt   DateTime @default(now()) @map("created_at")
  
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  @@index([botId])
  @@map("leads")
}

// ==================== Sitemap Crawl Jobs ====================

model SitemapCrawl {
  id             String   @id @default(cuid())
  botId          String   @map("bot_id")
  status         String   @default("pending") // pending, processing, completed, failed
  sitemapUrl     String?  @map("sitemap_url")
  totalUrls      Int      @default(0) @map("total_urls")
  processedUrls  Int      @default(0) @map("processed_urls")
  failedUrls     Int      @default(0) @map("failed_urls")
  urls           Json     // Array of URLs to crawl
  currentIndex   Int      @default(0) @map("current_index")
  error          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  bot            Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  @@index([botId])
  @@map("sitemap_crawls")
}

// ==================== Product Images (for Image Matching) ====================

model ProductImage {
  id            String   @id @default(cuid())
  botId         String   @map("bot_id")
  productId     String   @map("product_id")
  name          String
  price         String?
  currency      String?  @default("ILS")
  imageUrl      String   @map("image_url")
  pageUrl       String   @map("page_url")
  description   String?  @db.Text
  brand         String?
  category      String?
  inStock       Boolean  @default(true) @map("in_stock")
  embedding     Json     // CLIP image embedding vector
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  bot           Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  @@index([botId])
  @@map("product_images")
}

// ==================== Admin Features ====================

model AdminBroadcast {
  id            String   @id @default(cuid())
  title         String
  content       String   @db.Text
  type          String   @default("info") // 'info', 'warning', 'update'
  targetUserId  String?  @map("target_user_id") // null = all users, userId = specific user
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@map("admin_broadcasts")
}

model ApiUsageLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  botId       String?  @map("bot_id")
  model       String   // 'gpt-4o', 'gpt-4.1', 'text-embedding-3-small'
  tokens      Int
  cost        Float    // Estimated cost in USD
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ==================== Pricing Plans ====================

model PricingPlan {
  id              String   @id @default(cuid())
  name            String   // 'Essential', 'Business', 'Premium'
  nameHe          String   @map("name_he") // Hebrew name
  slug            String   @unique // 'essential', 'business', 'premium'
  description     String?  @db.Text // Short description
  descriptionHe   String?  @map("description_he") @db.Text // Hebrew description
  price           Float    // Monthly price in ILS
  yearlyPrice     Float?   @map("yearly_price") // Yearly price in ILS (optional)
  isPopular       Boolean  @default(false) @map("is_popular")
  isBestValue     Boolean  @default(false) @map("is_best_value")
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  
  // Limits
  maxBots         Int      @default(1) @map("max_bots")
  maxMessages     Int      @default(500) @map("max_messages") // Messages per month
  maxCharacters   Int      @default(5000000) @map("max_characters") // Characters for training
  maxCrawlPages   Int      @default(100) @map("max_crawl_pages")
  maxTeamMembers  Int      @default(1) @map("max_team_members")
  
  // Features (stored as JSON array of strings)
  features        Json     // Array of feature strings
  featuresHe      Json     @map("features_he") // Hebrew features
  
  // Feature flags
  hasLiveChat     Boolean  @default(false) @map("has_live_chat")
  hasTranslation  Boolean  @default(false) @map("has_translation")
  hasAutoRetrain  Boolean  @default(false) @map("has_auto_retrain")
  hasIntegrations Boolean  @default(false) @map("has_integrations")
  hasPrioritySupport Boolean @default(false) @map("has_priority_support")
  hasRemoveBranding Boolean @default(false) @map("has_remove_branding")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("pricing_plans")
}

// ==================== Payments ====================

model Payment {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  type            String   // 'subscription', 'credits', 'one_time'
  amount          Float    // Amount in ILS
  currency        String   @default("ILS")
  status          String   @default("pending") // 'pending', 'completed', 'failed', 'refunded'
  
  // YaadPay transaction data
  yaadTransId     String?  @map("yaad_trans_id")
  yaadAsmachta    String?  @map("yaad_asmachta") // אסמכתא
  yaadToken       String?  @map("yaad_token") // Token for recurring
  
  // What was purchased
  planId          String?  @map("plan_id")
  creditsAmount   Int?     @map("credits_amount")
  
  // Metadata
  orderId         String   @unique @map("order_id")
  description     String?  @db.Text
  errorMessage    String?  @map("error_message") @db.Text
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([status])
  @@map("payments")
}

model Subscription {
  id              String    @id @default(cuid())
  userId          String    @unique @map("user_id")
  planId          String    @map("plan_id")
  
  // YaadPay recurring data (הוראות קבע)
  yaadHkId        String?   @map("yaad_hk_id") // Agreement ID for recurring
  yaadToken       String?   @map("yaad_token")
  
  status          String    @default("active") // 'active', 'cancelled', 'expired', 'past_due'
  
  // Billing cycle
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")
  nextBillingDate    DateTime? @map("next_billing_date")
  
  // Payment info
  lastPaymentId   String?   @map("last_payment_id")
  lastPaymentDate DateTime? @map("last_payment_date")
  failedAttempts  Int       @default(0) @map("failed_attempts")
  
  cancelledAt     DateTime? @map("cancelled_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@map("subscriptions")
}
